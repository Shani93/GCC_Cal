{% extends "base.html" %}

{% block content %}
<!-- Header with Background Image and Main Logo -->
<div class="header-container" style="background-image: url('{{ url_for('static', filename='images/hh.png') }}'); background-size: cover; background-position: center; padding: 20px 0;">
    <div class="container">
        <div class="header-content text-center">
            <div class="logo-section">
                <a href="https://gatewai.io" target="_blank" class="logo-link">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Company Logo" class="company-logo">
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Title Section with Infraflex Logo Above -->
<div class="title-below-header">
    <div class="container text-center">
        <div class="infraflex-logo mb-3">
            <img src="{{ url_for('static', filename='images/logo2.png') }}" alt="Infraflex Logo" class="infraflex-logo-img">
        </div>
        <h1 class="main-header">GCC Setup Cost Calculator</h1>
    </div>
</div>

<!-- Tagline Section in One Line -->
<div class="tagline-section">
    <div class="tagline-container text-center">
        <p class="tagline">
            gatewAI's Infraflex* is a smart cost-calculator designed to help companies accurately estimate the total investment required to set up offices across Indian cities. It offers transparent insights for informed decision-making on infrastructure planning and expansion.
        </p>
    </div>
</div>

<div class="container main-container">
    <!-- Top Row: Configuration + Plan Selection + Component Selection -->
    <form id="calculator-form" method="POST" action="{{ url_for('calculate') }}">
        <div class="row g-4" style="display: flex; flex-wrap: nowrap;">
            <!-- Configuration -->
            <div class="col-md-4" style="flex: 1;">
                <div class="sidebar-card config-section">
                    <h4 class="section-header">Configuration</h4>
                    <!-- Headcount -->
                    <div class="mb-4">
                        <label for="headcount" class="form-label">Select Headcount</label>
                        <input type="range" class="form-range" id="headcount" name="headcount" min="1" max="1000" value="{{ results.headcount }}" oninput="updateHeadcountValue(this.value)">
                        <div class="d-flex justify-content-between">
                            <span>1</span>
                            <span id="headcount-value">{{ results.headcount }}</span>
                            <span>1000</span>
                        </div>
                    </div>
                    
                    <!-- Tier Selection -->
                    <div class="mb-4">
                        <label for="tier" class="form-label">Select Tier</label>
                        <select class="form-select" id="tier" name="tier" onchange="updateCities()">
                            {% for tier in cities_by_tier.keys() %}
                            <option value="{{ tier }}" {% if results.tier == tier %}selected{% endif %}>{{ tier }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- City Selection -->
                    <div class="mb-4">
                        <label for="city" class="form-label">Select City</label>
                        <select class="form-select" id="city" name="city">
                            <option value="{{ results.city }}" selected>{{ results.city }}</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Plan Selection - Modified for vertical layout -->
            <div class="col-md-4" style="flex: 1;">
                <div class="sidebar-card">
                    <h4 class="section-header">Plan Selection</h4>
                    <div class="plan-selection-vertical mb-4">
                        <div class="plan-card-vertical plan-card basic mb-3" id="basic-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>Basic</h6>
                                    <p class="small mb-0">Essential setup</p>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectPlan('Basic')">Select</button>
                            </div>
                        </div>
                        <div class="plan-card-vertical plan-card premium mb-3" id="premium-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>Premium</h6>
                                    <p class="small mb-0">Enhanced features</p>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectPlan('Premium')">Select</button>
                            </div>
                        </div>
                        <div class="plan-card-vertical plan-card advance" id="advance-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>Advance</h6>
                                    <p class="small mb-0">Fully customized</p>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectPlan('Advance')">Select</button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="plan" name="plan" value="Basic">
                </div>
            </div>


            <!-- Component Selection - Updated to match Plan Selection style -->
            <div class="col-md-4" style="flex: 1;">
                <div class="sidebar-card">
                    <h4 class="section-header">Component Selection</h4>
                    <div class="component-selection-vertical mb-4">
                        <div class="component-card-vertical mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>Real Estate</h6>
                                    <p class="small mb-0">Office space & facilities</p>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="real_estate" name="real_estate" {% if results.real_estate_toggle %}checked{% endif %}>
                                </div>
                            </div>
                        </div>
                        <div class="component-card-vertical mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>IT Infrastructure</h6>
                                    <p class="small mb-0">Hardware, networking & security</p>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="it_infra" name="it_infra" {% if results.it_infra_toggle %}checked{% endif %}>
                                </div>
                            </div>
                        </div>
                        <div class="component-card-vertical mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>Enabling Functions</h6>
                                    <p class="small mb-0">HR, Finance & Admin</p>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enabling" name="enabling" {% if results.enabling_toggle %}checked{% endif %}>
                                </div>
                            </div>
                        </div>
                        <div class="component-card-vertical">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6>Software Licensing Fee</h6>
                                    <p class="small mb-0">Applications & platforms</p>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="technology" name="technology" {% if results.technology_toggle %}checked{% endif %}>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Calculate Cost</button>
                </div>
            </div>
        </div>
    </form>

    <!-- Bottom Row: Calculation Results (Left) + Plan Details (Right) -->
    <div class="row g-4 mt-3" style="display: flex; flex-wrap: nowrap;">
        <!-- Calculation Results -->
        <div class="col-md-8" style="flex: 2;">
            <div class="content-card">
                <h4 class="section-header">Calculation Results</h4>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="metric-card">
                            <h6>Total Monthly Cost (INR)</h6>
                            <h2 class="orange-text">₹{{ "{:,.0f}".format(results.total_cost) }}</h2>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="metric-card">
                            <h6>Cost (USD/hour/head)</h6>
                            <h2 class="orange-text">${{ "%.2f"|format(results.hourly_cost_per_head_usd) }}</h2>
                        </div>
                    </div>
                </div>
                
                <h6>Cost Breakdown (Monthly):</h6>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            {% if results.real_estate_toggle %}
                            <li><strong>Real Estate:</strong> ₹{{ "{:,.0f}".format(results.total_real_estate_cost) }}</li>
                            {% endif %}
                            {% if results.it_infra_toggle %}
                            <li><strong>IT Infrastructure:</strong> ₹{{ "{:,.0f}".format(results.total_it_infra_cost) }}</li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            {% if results.enabling_toggle %}
                            <li><strong>Enabling Functions:</strong> ₹{{ "{:,.0f}".format(results.enab_cost) }}</li>
                            {% endif %}
                            {% if results.technology_toggle %}
                            <li><strong>Software Licensing:</strong> ₹{{ "{:,.0f}".format(results.tech_cost) }}</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                
                <h6 class="mt-4">Configuration:</h6>
                <p>Headcount: {{ results.headcount }} | City: {{ results.city }} ({{ results.tier }}) | Plan: {{ results.plan }}</p>
                
                <div class="mt-4">
                    <button class="btn btn-primary" onclick="downloadReport()">
                        <i class="fas fa-download me-2"></i>Download Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Plan Details -->
        <div class="col-md-4" style="flex: 1;">
            <div class="content-card">
                <h4 class="section-header">Plan Details</h4>
                <h5>{{ results.plan_details.name }}</h5>
                <p id="plan-description" class="fst-italic">{{ results.plan_details.description }}</p>
                <h6>Components Included:</h6>
                <ul class="list-unstyled">
                    <li><strong>Real Estate:</strong> <span>{{ results.plan_details.real_estate }}</span></li>
                    <li><strong>IT Infrastructure:</strong> <span>{{ results.plan_details.it_infra }}</span></li>
                    <li><strong>Enabling Functions:</strong> <span>{{ results.plan_details.enabling_functions }}</span></li>
                    <li><strong>Technology:</strong> <span>{{ results.plan_details.technology }}</span></li>
                </ul>
                <div class="alert alert-info">
                    Note: Premium/Advance plans may increase totals by 3–5% depending on modules and customizations.
                </div>
            </div>
        </div>
    </div>
</div>

<hr class="my-5">

<!-- Footer -->
<div class="row">
   
        <div class="col-12 text-center "> *The cost estimates provided by Infraflex are indicative and approximate. 
            Actual costs may vary depending on location, vendor negotiations, and other factors.</div>
           
       
    <div class="col-12 text-center footer">
        
        <p>GCC Setup Cost Calculator v1.0</p>
    </div>
</div>

<!-- Add some custom CSS for the vertical plan cards -->
<style>
    .plan-selection-vertical {
    display: flex;
    flex-direction: column;  /* keep vertical stacking */
    gap: 15px;               /* space between plans */
    width: 100%;             /* take full width of parent container */
}

.plan-card-vertical {
    width: 100%;             /* stretch full left to right */
    padding: 11px;
    border: 1px solid #ddd;
    border-radius: 8px;
    transition: all 0.3s ease;
    cursor: pointer;
    box-sizing: border-box;  /* include padding in width */
}

.plan-card-vertical.selected {
    border-color: #0d6efd;
    background-color: rgba(13, 110, 253, 0.05);
}

.plan-card-vertical:hover {
    background-color: #f8f9fa;
}


    /* Component Selection Styles to match Plan Selection */
    .component-selection-vertical {
        display: flex;
        flex-direction: column;
    }

    .component-card-vertical {
        padding: 3px;
        border: 1px solid #ddd;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .component-card-vertical:hover {
        background-color: #f8f9fa;
        border-color: #FFE4D6;
    }

    .component-card-vertical h6 {
        margin-bottom: 2px;
        color: #333;
        font-size: 0.95rem;
        font-weight: 600;
    }

    .component-card-vertical .small {
        color: #666;
        font-size: 0.8rem;
        margin-bottom: 0;
    }

    /* Form switch customization */
    .component-card-vertical .form-check-input {
        width: 2.8em;
        height: 1.5em;
    }

    .component-card-vertical .form-check-input:checked {
        background-color: #FF7F41;
        border-color: #FF7F41;
    }

    /* Ensure consistent spacing */
    .component-selection-vertical.mb-4 {
        margin-bottom: 1.5rem !important;
    }
</style>

<script>
    // Cities data for each tier
    const citiesByTier = {{ cities_by_tier | tojson }};

    function updateHeadcountValue(value) {
        document.getElementById('headcount-value').textContent = value;
    }
    
    function updateCities() {
        const tier = document.getElementById('tier').value;
        const citySelect = document.getElementById('city');
        const currentCity = citySelect.value;
        
        // Clear existing options
        citySelect.innerHTML = '';
        
        // Add new options
        citiesByTier[tier].forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            
            // Preselect the current city if it exists in the new tier
            if (city === currentCity) {
                option.selected = true;
            }
            
            citySelect.appendChild(option);
        });
        
        // If current city doesn't exist in the new tier, select the first city
        if (!citiesByTier[tier].includes(currentCity)) {
            citySelect.selectedIndex = 0;
        }
    }
    
    function selectPlan(plan) {
        document.getElementById('plan').value = plan;
        
        // Update UI
        const planCards = document.querySelectorAll('.plan-card-vertical');
        planCards.forEach(card => {
            card.classList.remove('selected');
        });
        
        document.getElementById(`${plan.toLowerCase()}-card`).classList.add('selected');
    }
    
    function downloadReport() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // ✅ Safely embed values as numbers
    const totalCost = {{ results.total_cost|tojson }};
    const usdCost = {{ results.hourly_cost_per_head_usd|tojson }};
    const realEstate = {{ results.total_real_estate_cost|tojson }};
    const itInfra = {{ results.total_it_infra_cost|tojson }};
    const enabling = {{ results.enab_cost|tojson }};
    const technology = {{ results.tech_cost|tojson }};

    // ---------- IMAGE PATHS ----------
    const headerImg = "{{ url_for('static', filename='images/pdf_header.png') }}";
    const footerImg = "{{ url_for('static', filename='images/pdf_footer.jpeg') }}";

    // Define margins and dimensions
    const pageWidth = 210; // A4 width in mm
    const leftMargin = 15;
    const rightMargin = 15;
    const headerHeight = 45; // Increased header height
    const footerHeight = 20;
    const contentWidth = pageWidth - leftMargin - rightMargin;

    function addHeaderFooter() {
        const pageCount = doc.internal.getNumberOfPages();
        
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);

            // Header image - full width with increased height
            doc.addImage(headerImg, "PNG", leftMargin, 5, contentWidth, headerHeight);

            // Footer image - full width with proper margins
            const footerY = doc.internal.pageSize.height - footerHeight - 10;
            doc.addImage(footerImg, "JPEG", leftMargin, footerY, contentWidth, footerHeight);
        }
    }

    // ---------- CONFIGURATION DETAILS ----------
    const startY = 60; // Increased space between header and content
    
    doc.setFontSize(14);
    doc.setTextColor(40, 40, 40);
    doc.text("Configuration Details", leftMargin, startY);

    const configData = [
        ["Headcount", "{{ results.headcount }}"],
        ["City", "{{ results.city }}"],
        ["Tier", "{{ results.tier }}"],
        ["Plan", "{{ results.plan }}"],
    ];

    doc.autoTable({
        startY: startY + 5,
        head: [["Parameter", "Value"]],
        body: configData,
        theme: 'grid',
        styles: { fontSize: 11, cellPadding: 3 },
        headStyles: { fillColor: [255, 127, 65], textColor: 255, fontStyle: 'bold' },
        margin: { left: leftMargin, right: rightMargin },
        tableWidth: contentWidth
    });

    // ---------- COST SUMMARY ----------
    let finalY = doc.lastAutoTable.finalY + 15;
    doc.setFontSize(14);
    doc.setTextColor(40, 40, 40);
    doc.text("Cost Summary", leftMargin, finalY);

    const costSummaryData = [
        ["Total Monthly Cost (INR)", "Rs. " + totalCost.toLocaleString("en-IN")],
        ["Cost (USD/hour/head)", "$" + usdCost.toFixed(2)],
    ];

    doc.autoTable({
        startY: finalY + 5,
        head: [["Metric", "Value"]],
        body: costSummaryData,
        theme: 'grid',
        styles: { fontSize: 11, cellPadding: 3 },
        headStyles: { fillColor: [52, 152, 219], textColor: 255, fontStyle: 'bold' },
        margin: { left: leftMargin, right: rightMargin },
        tableWidth: contentWidth
    });

    // ---------- COST BREAKDOWN ----------
    finalY = doc.lastAutoTable.finalY + 15;
    doc.setFontSize(14);
    doc.setTextColor(40, 40, 40);
    doc.text("Cost Breakdown (Monthly)", leftMargin, finalY);

    const tableData = [];
    {% if results.real_estate_toggle %}
    tableData.push(["Real Estate", "Rs. " + realEstate.toLocaleString("en-IN")]);
    {% endif %}
    {% if results.it_infra_toggle %}
    tableData.push(["IT Infrastructure", "Rs. " + itInfra.toLocaleString("en-IN")]);
    {% endif %}
    {% if results.enabling_toggle %}
    tableData.push(["Enabling Functions", "Rs. " + enabling.toLocaleString("en-IN")]);
    {% endif %}
    {% if results.technology_toggle %}
    tableData.push(["Software Licensing", "Rs. " + technology.toLocaleString("en-IN")]);
    {% endif %}

    // ✅ Add Grand Total row
    tableData.push(["Grand Total", "Rs. " + totalCost.toLocaleString("en-IN")]);

    doc.autoTable({
        startY: finalY + 5,
        head: [["Component", "Cost (INR)"]],
        body: tableData,
        theme: 'grid',
        styles: { fontSize: 11, cellPadding: 3 },
        headStyles: { fillColor: [46, 204, 113], textColor: 255, fontStyle: 'bold' },
        columnStyles: { 0: { fontStyle: "bold" }, 1: { fontStyle: "bold" } },
        margin: { left: leftMargin, right: rightMargin },
        tableWidth: contentWidth
    });

    // ---------- FOOTER PAGE NUMBER ----------
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(9);
        doc.setTextColor(120, 120, 120);
        
        // Position page number above footer
        const pageNumY = doc.internal.pageSize.height - footerHeight - 15;
        doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageNumY, { align: "center" });
    }

    // ✅ Add header & footer images AFTER all content
    addHeaderFooter();

    // ---------- SAVE ----------
    const now = new Date();
    const timestamp = now.toISOString().replace(/[-:]/g, '').split('.')[0];
    doc.save(`gcc_cost_report_${timestamp}.pdf`);
}
</script>
{% endblock %}